<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Forest Health Scanner</title>
  <style>
    /* ---------------------------------------------------------------------- */
    /* THEME VARIABLES */
    /* ---------------------------------------------------------------------- */
    :root {
      /* Light Theme (Default) - YOUR NEW COLORS */
      --bg1: #feada6;
      --bg2: #f5efef;
      
      --card-bg: rgba(255, 255, 255, 0.9);
      --text-main: #123;
      --text-muted: #556;
      --text-header: #084;
      --accent1: #B3FFAB;
      --accent2: #12FFF7;
      --accent3: #B3FFAB;
      --border-light: rgba(0, 0, 0, 0.05);
      --hr-bg: linear-gradient(90deg, transparent, rgba(0, 0, 0, 0.06), transparent);
    }

    body.dark-theme {
      /* Dark Theme Overrides */
      --bg1: #820286;
      --bg2: #5c1452;
      
      --card-bg: rgba(255, 255, 255, 0.08);
      --text-main: #e6fff7;
      --text-muted: #9ab;
      --text-header: #4df;
      --border-light: rgba(255, 255, 255, 0.1);
      --hr-bg: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
    }

    /* ---------------------------------------------------------------------- */
    /* BASE STYLES & MOBILE-FIRST LAYOUT */
    /* ---------------------------------------------------------------------- */
    * {
      box-sizing: border-box;
    }

    body {
      font-family: Inter, 'Segoe UI', Roboto, Arial;
      margin: 0;
      /* Mobile: Reduce padding */
      padding: 12px; 
      background: linear-gradient(to top, var(--bg1) 0%, var(--bg2) 100%);
      color: var(--text-main);
      transition: background 0.3s ease, color 0.3s ease;
    }

    .wrap {
      max-width: 1100px;
      margin: 0 auto;
      /* Default: Single column layout for mobile */
      display: grid; 
      grid-template-columns: 1fr;
      gap: 16px; /* Reduced gap */
      align-items: start;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      flex-wrap: wrap; /* Allow wrapping on small screens */
      gap: 10px;
    }
    
    .logo {
      height: 48px; /* Reduced logo size for mobile */
      margin-right: 10px; 
      border-radius: 8px;
    }

    header .title-group {
        flex-grow: 1;
        min-width: 150px;
    }
    
    header h1 {
      font-size: 18px; /* Reduced font size */
      margin: 0;
      color: var(--text-header);
      letter-spacing: 0.2px;
    }

    header .small {
      font-size: 12px;
      color: var(--text-muted);
    }
    
    .header-controls {
        display:flex; 
        gap:6px; 
        align-items:center;
    }
    .lang-select {
        padding: 6px;
        font-size: 12px;
    }

    .card {
      background: var(--card-bg);
      border-radius: 12px; /* Slightly smaller radius */
      padding: 16px; /* Reduced padding */
      box-shadow: 0 8px 25px rgba(10, 20, 10, 0.05);
    }

    /* Left column */
    .uploader {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .preview {
      width: 100%;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid var(--border-light);
      background: #fafafa;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 200px; /* Reduced min-height for mobile */
    }

    .preview img {
      max-width: 100%;
      /* max-height: 420px; Removed max-height constraint for better mobile scaling */
      height: auto;
      display: block;
    }

    /* Button Styling */
    .btn-grad {
      /* Keep original gradient and effects */
      background-image: linear-gradient(to right, #ff9a8b 0%, #ff6a88 51%, #ff9a8b 100%);
      margin: 6px 0; /* Reduced margin */
      padding: 10px 20px; /* Reduced padding */
      font-size: 14px; /* Reduced font size */
      background-size: 200% auto;
      color: white;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
      border-radius: 8px; /* Reduced border radius */
      display: inline-block;
      border: none;
      font-weight: 600;
      letter-spacing: 0.5px;
      cursor: pointer;
      flex-grow: 1; /* Make buttons grow to fill space */
      min-width: 100px;
    }
    .btn-grad:hover {
        background-position: right center;
        color: #fff;
        text-decoration: none;
        transform: translateY(-1px); /* Less aggressive hover effect */
    }


    .controls {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .meta {
      display: flex;
      gap: 10px;
      align-items: flex-start; /* Aligned to start to prevent ref image from pushing text */
      justify-content: space-between;
      flex-wrap: wrap; /* Ensure text and ref image wrap if needed */
    }
    
    /* Removed the .ref CSS block entirely, as the element is gone. */


    /* NEW PROGRESS BAR STYLES */
    .health-meter {
        background: #eee;
        border-radius: 6px;
        height: 12px;
        margin-top: 10px;
        overflow: hidden;
    }

    .health-bar {
        height: 100%;
        width: 0%; /* Will be set by JS */
        transition: width 0.6s ease-out;
        /* Default colors for different states (will be overridden by JS) */
        background: #ccc; 
    }
    
    .res-healthy .health-bar { background: #008000; }
    .res-dry .health-bar { background: #FFD700; }
    .res-disease .health-bar { background: #FF4500; }
    .res-pest .health-bar { background: #8B4513; }
    .res-risk .health-bar { background: #DC143C; }


    /* result box */
    #resultBox {
      display: none;
      padding: 10px; /* Reduced padding */
      border-radius: 8px;
      font-weight: 600;
      text-align: center;
      margin-top: 8px;
    }
    
    .result-actions {
      margin-top: 8px; 
      display: flex; 
      gap: 6px; 
      justify-content: space-between; /* Spread buttons out */
      flex-wrap: wrap;
    }
    .result-actions .btn-grad {
        min-width: unset;
        font-size: 12px;
        padding: 8px 10px;
        flex-grow: 1;
    }

    /* Right column (logs/guide) */
    .side {
      display: flex;
      flex-direction: column;
      gap: 12px;
      order: 2; /* Ensure side content loads below main content on mobile */
    }
    
    /* Logs table adjustment for mobile */
    table {
      font-size: 12px;
    }
    th, td {
      padding: 6px;
    }

    /* ---------------------------------------------------------------------- */
    /* DESKTOP OVERRIDES */
    /* ---------------------------------------------------------------------- */
    @media (min-width: 920px) {
      .wrap {
        /* Desktop: Two column layout */
        grid-template-columns: 1fr 380px;
        gap: 22px;
      }
      .side {
        order: unset; /* Reset order on desktop */
      }
      /* Removed .ref desktop override */
      
      header h1 {
          font-size: 20px;
      }
      header .small {
          font-size: 13px;
      }
      .logo {
          height: 70px; 
      }
    }
  </style>
</head>
<body>
  <header>
    <img src="logo.png" alt="Forest Scanner Logo" class="logo">
    
    <div class="title-group">
      <h1 id="title">Forest Health Scanner</h1>
      <div class="small muted" id="subtitle">Detect tree dryness, disease & pest attack ‚Äî offline, community-friendly</div>
    </div>
    
    <div class="header-controls">
      <select id="lang" class="lang-select">
        <option value="en">English</option>
        <option value="hi">‡§π‡§ø‡§Ç‡§¶‡•Ä</option>
        <option value="ta">‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç</option>
        <option value="ur">ÿßÿ±ÿØŸà</option>
      </select>
      <button type="button" class="btn-grad" id="themeToggle" title="Toggle theme" aria-label="Toggle theme" style="padding: 8px 12px; min-width: unset;">üåì</button>
    </div>
  </header>

  <main class="wrap">
    <section class="card">
      <div class="uploader">
        <div class="meta">
          <div>
            <strong id="uploadTitle">Upload or take a photo</strong>
            <div class="muted" id="uploadHint">Use camera to capture leaf, bark or ground</div>
          </div>
        </div>

        <div class="preview" id="preview">
          <div class="muted">No image selected</div>
        </div>

        <div class="controls">
          <label class="upload-btn btn-grad" for="fileInput">
            <input id="fileInput" type="file" accept="image/*" capture="camera" style="display:none">
            üì∑ Capture / Upload
          </label>

          <button type="button" class="btn-grad" id="analyzeButton">Analyze</button>
          <button type="button" class="btn-grad" id="logsButton">Logs</button>
        </div>

        <div id="resultArea" style="margin-top: 10px;">
            <div id="confText" class="muted">Confidence: --</div>
            <div class="health-meter">
                <div id="healthBar" class="health-bar" style="width: 0%;"></div>
            </div>
            <div id="resultBox"></div>
        </div>
        
        <div class="badges" id="badgesArea">
          <div class="badge">Community Edition</div>
        </div>

      </div>
    </section>

    <aside class="side">
      <div class="card">
        <strong id="howTitle">How it helps</strong>
        <p class="muted" id="howText">Detects stressed trees early, prevents future fires, and teaches villagers how to protect forests.</p>

        <hr style="border:none; height:1px; background:var(--hr-bg); margin:12px 0">

        <div><strong id="recentTitle">Recent Detections</strong></div>
        <div style="max-height:250px; overflow:auto; margin-top:8px">
          <table id="logsTable">
            <thead>
              <tr>
                <th>When</th>
                <th>Result</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="2" class="muted">No logs yet</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div style="margin-top:12px">
          <button type="button" class="btn-grad" id="exportButton">Export CSV</button>
        </div>
      </div>

      <div class="card">
        <strong id="eduTitle">Quick Guide</strong>
        <ol style="padding-left:18px; margin-top:8px" id="guideList">
          <li>Take a clear photo of leaf or bark.</li>
          <li>Tap <em>Analyze</em> and wait for result.</li>
          <li>If result says drying/disease, take action or inform volunteers.</li>
        </ol>
      </div>

    </aside>
  </main>

  <script>
    // --- All code wrapped in DOMContentLoaded ---
    document.addEventListener("DOMContentLoaded", () => {

      // --- Translations ---
      const L = {
        en: {
          title: 'Forest Health Scanner', subtitle: 'Detect tree dryness, disease & pest attack ‚Äî offline, community-friendly',
          uploadTitle: 'Upload or take a photo', uploadHint: 'Use camera to capture leaf, bark or ground',
          analyze: 'Analyze', collect: 'Capture / Upload', logs: 'Logs', how: 'Detects stressed trees early, prevents future fires, and teaches villagers how to protect forests.',
          guide1: 'Take a clear photo of leaf or bark.', guide2: 'Tap Analyze and wait for result.', guide3: 'If result says drying/disease, take action or inform volunteers.',
          result_healthy: 'Healthy', result_drying: 'Drying / Early risk', result_disease: 'Disease detected', result_pest: 'Pest attack', result_risk: 'High fire-risk zone',
        },
        hi: {
          title: '‡§µ‡•É‡§ï‡•ç‡§∑ ‡§∏‡•ç‡§µ‡§æ‡§∏‡•ç‡§•‡•ç‡§Ø ‡§∏‡•ç‡§ï‡•à‡§®‡§∞', subtitle: '‡§™‡•á‡§°‡§º ‡§ï‡•Ä ‡§∏‡•Ç‡§ñ‡§æ‡§™‡§®, ‡§∞‡•ã‡§ó ‡§î‡§∞ ‡§ï‡•Ä‡§ü ‡§™‡§π‡§ö‡§æ‡§®‡•á‡§Ç ‚Äî ‡§ë‡§´‡§º‡§≤‡§æ‡§á‡§®, ‡§∏‡§Æ‡•Å‡§¶‡§æ‡§Ø ‡§ï‡•á ‡§≤‡§ø‡§è',
          uploadTitle: '‡§´‡•ã‡§ü‡•ã ‡§Ö‡§™‡§≤‡•ã‡§° ‡§Ø‡§æ ‡§≤‡•á‡§Ç', uploadHint: '‡§™‡§§‡•ç‡§§‡§æ, ‡§õ‡§æ‡§≤ ‡§Ø‡§æ ‡§ú‡§Æ‡•Ä‡§® ‡§ï‡•Ä ‡§§‡§∏‡•ç‡§µ‡•Ä‡§∞ ‡§≤‡•á‡§Ç', analyze: '‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£', collect:'‡§ï‡•àŸæ‡•ç‡§öÿ± / ‡§Ö‡§™‡§≤‡•ã‡§°', logs:'‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü', how: ' ‡§™‡•á‡§°‡§º ‡§ï‡•á ‡§¶‡§¨‡§æ‡§µ ‡§ï‡§æ ‡§ú‡§≤‡•ç‡§¶‡•Ä ‡§™‡§§‡§æ ‡§≤‡§ó‡§æ‡§§‡§æ ‡§π‡•à ‡§î‡§∞ ‡§Ü‡§ó ‡§ï‡•ã ‡§∞‡•ã‡§ï‡§§‡§æ ‡§π‡•à‡•§',
          guide1:'‡§™‡§§‡•ç‡§§‡•Ä ‡§Ø‡§æ ‡§õ‡§æ‡§≤ ‡§ï‡•Ä ‡§∏‡§æ‡§´‡§º ‡§§‡§∏‡•ç‡§µ‡•Ä‡§∞ ‡§≤‡•á‡§Ç‡•§', guide2:'‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£ ‡§™‡§∞ ‡§ü‡•à‡§™ ‡§ï‡§∞‡•á‡§Ç ‡§î‡§∞ ‡§™‡§∞‡§ø‡§£‡§æ‡§Æ ‡§ï‡§æ ‡§á‡§Ç‡§§‡§ú‡§æ‡§∞ ‡§ï‡§∞‡•á‡§Ç‡•§', guide3:'‡§Ø‡§¶‡§ø ‡§∏‡•Ç‡§ñ‡§æ/‡§∞‡•ã‡§ó ‡§¶‡§ø‡§ñ‡•á, ‡§§‡•ã ‡§ï‡§¶‡§Æ ‡§â‡§†‡§æ‡§è‡§Ç ‡§Ø‡§æ ‡§∏‡•ç‡§µ‡§Ø‡§Ç‡§∏‡•á‡§µ‡§ï‡•ã‡§Ç ‡§ï‡•ã ‡§∏‡•Ç‡§ö‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç‡•§',
          result_healthy: '‡§∏‡•ç‡§µ‡§∏‡•ç‡§•', result_drying: '‡§∏‡•Ç‡§ñ‡§æ / ‡§∂‡•Å‡§∞‡•Å‡§Ü‡§§‡•Ä ‡§ñ‡§§‡§∞‡§æ', result_disease: '‡§∞‡•ã‡§ó ‡§™‡§æ‡§Ø‡§æ ‡§ó‡§Ø‡§æ', result_pest: '‡§ï‡•Ä‡§ü ‡§π‡§Æ‡§≤‡§æ', result_risk: '‡§Ü‡§ó ‡§ï‡§æ ‡§â‡§ö‡•ç‡§ö ‡§ñ‡§§‡§∞‡§æ',
        },
        ta: {
          title: '‡ÆÆ‡Æ∞‡ÆÆ‡Øç ‡ÆÜ‡Æ∞‡Øã‡Æï‡Øç‡Æï‡Æø‡ÆØ ‡Æ∏‡Øç‡Æï‡Øá‡Æ©‡Æ∞‡Øç', subtitle: '‡ÆÆ‡Æ∞‡Æ§‡Øç‡Æ§‡Æø‡Æ©‡Øç ‡Æµ‡Æ±‡Æü‡Øç‡Æö‡Æø‡Æ§‡Øç‡Æ§‡Æ©‡Øç‡ÆÆ‡Øà, ‡Æ®‡Øã‡ÆØ‡Øç ‡ÆÆ‡Æ±‡Øç‡Æ±‡ØÅ‡ÆÆ‡Øç ‡Æ™‡ØÇ‡Æö‡Øç‡Æö‡Æø ‡Æ§‡Ææ‡Æï‡Øç‡Æï‡Æ§‡Øç‡Æ§‡Øà ‡Æï‡Æ£‡Øç‡Æü‡Æ±‡Æø‡Æ§‡Æ≤‡Øç ‚Äî ‡ÆÜ‡ÆÉ‡Æ™‡Øç‡Æ≤‡Øà‡Æ©‡Øç',
          uploadTitle: '‡Æ™‡Æü‡Æ§‡Øç‡Æ§‡Øà ‡Æ™‡Æ§‡Æø‡Æµ‡Øá‡Æ±‡Øç‡Æ±‡ØÅ ‡ÆÖ‡Æ≤‡Øç‡Æ≤‡Æ§‡ØÅ ‡Æé‡Æü‡ØÅ‡Æ§‡Øç‡Æ§‡ØÅ‡Æï‡Øç‡Æï‡Øã', uploadHint:'‡Æá‡Æ≤‡Øà, ‡Æ§‡Øã‡Æ≤‡Øç ‡ÆÖ‡Æ≤‡Øç‡Æ≤‡Æ§‡ØÅ ÿ≤ŸÖ€åŸÜ-‡Æê‡Æ™‡Øç ‡Æ™‡ØÅ‡Æ§‡Æø‡Æï', analyze:'‡Æ™‡Æï‡ØÅ‡Æ™‡Øç‡Æ™‡Ææ‡ÆØ‡Øç‡Æµ‡ØÅ', collect:'‡Æ™‡Æø‡Æü‡Æø / ‡Æ™‡Æ§‡Æø‡Æµ‡Øá‡Æ±‡Øç‡Æ±‡ØÅ', logs:'‡ÆÖ‡Æ±‡Æø‡Æï‡Øç‡Æï‡Øà‡Æï‡Æ≥‡Øç', how:'‡ÆÆ‡Æ∞‡Æï‡Øç ‡Æï‡Ææ‡ÆØ‡Øç‡Æö‡Øç‡Æö‡Æ≤‡Øà ‡ÆÆ‡ØÅ‡Æ©‡Øç‡Æ©‡Æ∞‡Øá ‡Æï‡Æ£‡Øç‡Æü‡Æ±‡Æø‡Æ®‡Øç‡Æ§‡ØÅ ‡Æ§‡ØÄ‡ÆØ‡Øà‡Æï‡Øç ‡Æï‡ØÅ‡Æ±‡Øà‡Æï‡Øç‡Æï‡ØÅ‡ÆÆ‡Øç',
          guide1:'‡Æá‡Æ≤‡Øà ‡ÆÖ‡Æ≤‡Øç‡Æ≤‡Æ§‡ØÅ ‡Æ§‡Øã‡Æ≤‡Æø‡Æ©‡Øç ‡Æ§‡ØÜ‡Æ≥‡Æø‡Æµ‡Ææ‡Æ© ‡Æ™‡Æü‡ÆÆ‡Øç ‡Æé‡Æü‡ØÅ‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç.', guide2:'"‡Æ™‡Æï‡ØÅ‡Æ™‡Øç‡Æ™‡Ææ‡ÆØ‡Øç‡Æµ‡ØÅ" ‡Æö‡Øä‡Æü‡ØÅ‡Æï‡Øç‡Æï‡Æø ‡ÆÆ‡ØÅ‡Æü‡Æø‡Æµ‡Øà‡Æï‡Øç ‡Æï‡Ææ‡Æ§‡Øç‡Æ§‡Æø‡Æ∞‡ØÅ‡Æô‡Øç‡Æï‡Æ≥‡Øç.', guide3:'‡Æâ‡Æ≤‡Æ∞‡Øç‡Æ®‡Øç‡Æ§‡Æ§‡ØÅ/‡Æ®‡Øã‡ÆØ‡Ææ‡Æ£‡ØÜ‡Æ©‡Æø‡Æ≤‡Øç ‡Æ®‡Æü‡Æµ‡Æü‡Æø‡Æï‡Øç‡Æï‡Øà ‡Æé‡Æü‡ØÅ‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç.',
          result_healthy: '‡ÆÜ‡Æ∞‡Øã‡Æï‡Øç‡Æï‡Æø‡ÆØ‡ÆÆ‡Ææ‡Æ©‡Æ§‡ØÅ', result_drying: '‡Æµ‡Æ±‡Æü‡Øç‡Æö‡Æø / ‡ÆÜ‡Æ∞‡ÆÆ‡Øç‡Æ™ ‡ÆÜ‡Æ™‡Æ§‡Øç‡Æ§‡ØÅ', result_disease: '‡Æ®‡Øã‡ÆØ‡Øç ‡Æï‡Æ£‡Øç‡Æü‡Æ±‡Æø‡ÆØ‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü‡Æ§‡ØÅ', result_pest: '‡Æ™‡ØÇ‡Æö‡Øç‡Æö‡Æø ‡Æ§‡Ææ‡Æï‡Øç‡Æï‡ØÅ‡Æ§‡Æ≤‡Øç', result_risk: '‡ÆÖ‡Æ§‡Æø‡Æï ‡Æ§‡ØÄ ‡ÆÜ‡Æ™‡Æ§‡Øç‡Æ§‡ØÅ',
        },
        ur: {
          title: 'ÿØÿ±ÿÆÿ™ ⁄©€å ÿµÿ≠ÿ™ ÿßÿ≥⁄©€åŸÜÿ±', subtitle: 'ÿØÿ±ÿÆÿ™ ⁄©€å ÿÆÿ¥kiÿå ÿ®€åŸÖÿßÿ±€å ÿßŸàÿ± ⁄©€å⁄ëŸà⁄∫ ⁄©ÿß Ÿæÿ™€Å ŸÑ⁄Øÿßÿ¶€å⁄∫ ‚Äî ÿ¢ŸÅ ŸÑÿßÿ¶ŸÜÿå ⁄©ŸÖ€åŸàŸÜŸπ€å ⁄©€í ŸÑ€å€í',
          uploadTitle: 'ÿ™ÿµŸà€åÿ± ÿßŸæ ŸÑŸà⁄à €åÿß ŸÑ€å⁄∫', uploadHint: 'Ÿæÿ™ÿßÿå ⁄Ü⁄æÿßŸÑ €åÿß ÿ≤ŸÖ€åŸÜ ⁄©€å ÿ™ÿµŸà€åÿ± ŸÑ€å⁄∫', analyze:'ÿ™ÿ¨ÿ≤€å€Å ⁄©ÿ±€å⁄∫', collect:'⁄©€åŸæ⁄Üÿ± / ÿßŸæ ŸÑŸà⁄à', logs:'ŸÑÿß⁄Øÿ≤', how:'ÿØÿ±ÿÆÿ™Ÿà⁄∫ ⁄©€í ÿØÿ®ÿßÿ§ ⁄©Ÿà ÿ¨ŸÑÿØ€å Ÿæ⁄©⁄ëÿ™ÿß €Å€í ÿßŸàÿ± ÿ¢⁄Ø ⁄©Ÿà ÿ±Ÿà⁄©ÿ™ÿß €Å€í€î',
          guide1:'Ÿæÿ™€í €åÿß ⁄Ü⁄æÿßŸÑ ⁄©€å Ÿàÿßÿ∂ÿ≠ ÿ™ÿµŸà€åÿ± ŸÑ€å⁄∫€î', guide2:'ÿ™ÿ¨ÿ≤€å€Å Ÿæÿ± Ÿπ€åP ⁄©ÿ±€å⁄∫ ÿßŸàÿ± ŸÜÿ™€åÿ¨€í ⁄©ÿß ÿßŸÜÿ™ÿ∏ÿßÿ± ⁄©ÿ±€å⁄∫€î', guide3:'ÿß⁄Øÿ± ÿÆÿ¥⁄©/ŸÖÿ±ÿ∂ ÿ∏ÿß€Åÿ± €ÅŸà ÿ™Ÿà ÿßŸÇÿØÿßŸÖÿßÿ™ ⁄©ÿ±€å⁄∫ €åÿß ÿ±ÿ∂ÿß ⁄©ÿßÿ±Ÿà⁄∫ ⁄©Ÿà ÿ®ÿ™ÿßÿ¶€å⁄∫€î',
          result_healthy: 'ÿµÿ≠ÿ™ ŸÖŸÜÿØ', result_drying: 'ÿÆÿ¥⁄© €ÅŸàŸÜÿß / ÿßÿ®ÿ™ÿØÿßÿ¶€å ÿÆÿ∑ÿ±€Å', result_disease: 'ÿ®€åŸÖÿßÿ±€å ⁄©ÿß Ÿæÿ™€Å ⁄ÜŸÑÿß', result_pest: '⁄©€å⁄ëŸà⁄∫ ⁄©ÿß ÿ≠ŸÖŸÑ€Å', result_risk: 'ÿ¢⁄Ø ⁄©ÿß ÿ≤€åÿßÿØ€Å ÿÆÿ∑ÿ±€Å',
        }
      };

      // --- Cache DOM Elements ---
      const langSelect = document.getElementById('lang');
      const themeToggleButton = document.getElementById('themeToggle');
      const fileInput = document.getElementById('fileInput');
      const analyzeButton = document.getElementById('analyzeButton');
      const logsButton = document.getElementById('logsButton');
      const exportButton = document.getElementById('exportButton');
      
      const previewBox = document.getElementById('preview');
      const resultBox = document.getElementById('resultBox');
      const confText = document.getElementById('confText');
      const healthBar = document.getElementById('healthBar');
      const logsTableBody = document.querySelector('#logsTable tbody');
      const guideList = document.getElementById('guideList').children;
      
      const titleEl = document.getElementById('title');
      const subtitleEl = document.getElementById('subtitle');
      const uploadTitleEl = document.getElementById('uploadTitle');
      const uploadHintEl = document.getElementById('uploadHint');
      const howTextEl = document.getElementById('howText');
      const howTitleEl = document.getElementById('howTitle');
      
      // --- State Variables ---
      let currentFile = null;
      let lastLogId = null;

      // --- UI wiring (Event Listeners) ---
      themeToggleButton.addEventListener('click', toggleTheme);
      langSelect.addEventListener('change', () => setLang(langSelect.value));
      fileInput.addEventListener('change', handleFile);
      analyzeButton.addEventListener('click', sendImage);
      logsButton.addEventListener('click', showLogs);
      exportButton.addEventListener('click', exportCSV);
      
      // --- Custom Modal for Alerts/Prompts (reused) ---
      function showModal(text, requiresInput = false, callback = null) {
        // ... (Modal implementation is the same) ...
        const oldModal = document.getElementById('customModal');
        if (oldModal) {
          oldModal.remove();
        }

        const modalBackdrop = document.createElement('div');
        modalBackdrop.id = 'customModal';
        modalBackdrop.style.cssText = `
          position: fixed; top: 0; left: 0; width: 100%; height: 100%;
          background: rgba(0,0,0,0.5); display: flex; align-items: center;
          justify-content: center; z-index: 1000;
        `;
        
        const modalContent = document.createElement('div');
        modalContent.style.cssText = `
          background: var(--card-bg, #fff); color: var(--text-main, #000);
          padding: 20px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
          min-width: 300px; max-width: 90%;
        `;
        
        const modalText = document.createElement('p');
        modalText.innerText = text;
        modalText.style.margin = '0 0 15px 0';
        modalContent.appendChild(modalText);
        
        let inputField;
        if (requiresInput) {
          inputField = document.createElement('input');
          inputField.type = 'text';
          inputField.style.cssText = `
            width: 100%; padding: 8px; border-radius: 5px; 
            border: 1px solid var(--border-light, #ccc); margin-bottom: 15px;
          `;
          modalContent.appendChild(inputField);
        }

        const buttonContainer = document.createElement('div');
        buttonContainer.style.textAlign = 'right';

        const okButton = document.createElement('button');
        okButton.innerText = 'OK';
        okButton.className = 'btn-grad'; 
        okButton.style.margin = '0 0 0 10px';
        
        okButton.onclick = () => {
          if (callback) {
            const value = requiresInput ? inputField.value : true;
            callback(value);
          }
          modalBackdrop.remove();
        };
        buttonContainer.appendChild(okButton);

        if (requiresInput || callback) {
           const cancelButton = document.createElement('button');
           cancelButton.innerText = 'Cancel';
           cancelButton.className = 'btn-grad';
           cancelButton.style.background = '#888'; 
           cancelButton.onclick = () => {
             if (callback) {
               callback(null); 
             }
             modalBackdrop.remove();
           };
           buttonContainer.appendChild(cancelButton);
        }
        
        modalContent.appendChild(buttonContainer);
        modalBackdrop.appendChild(modalContent);
        document.body.appendChild(modalBackdrop);

        if(inputField) inputField.focus();
      }


      // --- Functions ---
      function setLang(k) {
        const dict = L[k] || L.en;
        titleEl.innerText = dict.title;
        subtitleEl.innerText = dict.subtitle;
        uploadTitleEl.innerText = dict.uploadTitle;
        uploadHintEl.innerText = dict.uploadHint;
        howTextEl.innerText = dict.how;
        howTitleEl.innerText = dict.how ? 'How it helps' : '';
        const guides = [dict.guide1, dict.guide2, dict.guide3];
        for (let i = 0; i < 3; i++) {
          if(guideList[i]) guideList[i].innerText = guides[i];
        }
      }

      function toggleTheme() {
        document.body.classList.toggle("dark-theme");
      }

      function handleFile(e) {
        const f = e.target.files[0];
        if (!f) return;
        currentFile = f;
        const url = URL.createObjectURL(f);
        previewBox.innerHTML = ''; // Clear preview
        const img = document.createElement('img');
        img.src = url;
        previewBox.appendChild(img);
        
        // Reset results display
        resultBox.style.display = 'none';
        confText.innerText = 'Confidence: --';
        healthBar.style.width = '0%';
        resultBox.className = '';
      }

      async function sendImage() {
        if (!currentFile) {
          showModal('Please choose or capture an image first.');
          return;
        }
        
        // UI feedback while analyzing
        resultBox.style.display = 'none';
        confText.innerText = 'Analyzing...';
        healthBar.style.width = '0%';
        healthBar.className = 'health-bar';

        const form = new FormData();
        form.append('file', currentFile);
        form.append('lang', langSelect.value);
        
        try {
         // REPLACE 192.168.1.X with your actual IP from Step 1
        // REPLACE 192.168.1.X with your actual IP from Step 1
        const resp = await fetch('http://192.168.0.100/predict', { method: 'POST', body: form });
          if (!resp.ok) throw new Error('no-backend');
          const j = await resp.json();
          showResult(j.result, j.confidence, j.timestamp, j.id);
        } catch (err) {
          // MOCK fallback (random but biased to healthy)
          const choices = ['healthy', 'drying', 'disease', 'pest', 'risk'];
          // Use Math.random for a bit of realism
          const pick = choices[Math.floor(Math.random() * choices.length)]; 
          const conf = (0.6 + Math.random() * 0.35).toFixed(2);
          showResult(pick, conf, new Date().toISOString(), "mock_" + Date.now());
        }
      }

      function showResult(code, confidence, ts, id) {
        const confPct = Math.round(confidence * 100);
        resultBox.style.display = 'block';
        
        // 1. Update Confidence Text
        confText.innerText = `Confidence: ${confPct}% (${code.charAt(0).toUpperCase() + code.slice(1)})`;
        
        // 2. Update Progress Bar (Health Meter)
        const map = {
          healthy: 'res-healthy',
          drying: 'res-dry',
          disease: 'res-disease',
          pest: 'res-pest',
          risk: 'res-risk'
        };
        const mClass = map[code] || 'res-risk';
        
        healthBar.style.width = `${confPct}%`;
        healthBar.className = 'health-bar ' + mClass;
        
        // 3. Update Result Box Text
        const currentLang = langSelect.value;
        const resultText = L[currentLang][`result_${code}`] || L.en[`result_${code}`] || 'Unknown';
        
        resultBox.className = mClass;
        resultBox.innerHTML = `
          <strong>${resultText}</strong>
          <div class="result-timestamp">${new Date(ts).toUTCString()}</div>
          ${actionRowHTML()}
        `;
        lastLogId = id;
      }
      
      function actionRowHTML() {
        // Re-using the same action structure
        return `<div class="result-actions">
          <button type="button" class="btn-grad verify-btn">‚úÖ Verify</button>
          <button type="button" class="btn-grad correct-btn">‚úèÔ∏è Correct</button>
          <button type="button" class="btn-grad share-btn">üì§ Share</button>
        </div>`;
      }
      
      // --- Delegation for Action Buttons (Since they are dynamically loaded) ---
      document.body.addEventListener('click', (e) => {
          if (e.target.classList.contains('verify-btn')) {
              markVerified();
          } else if (e.target.classList.contains('correct-btn')) {
              correctLabel();
          } else if (e.target.classList.contains('share-btn')) {
              openShare();
          }
      });


      // --- Logs UI (reused) ---
      async function showLogs() {
        try {
          const resp = await fetch('http://192.168.0.100/logs');
          if (!resp.ok) throw new Error('no logs');
          const j = await resp.json();
          renderLogs(j.logs || []);
        } catch (e) {
          renderLogs([]); // Clear logs on error
          console.warn('Logs endpoint not available. Running in demo mode.');
        }
      }

      function renderLogs(rows) {
        logsTableBody.innerHTML = ''; // Clear table
        if (!rows.length) {
          logsTableBody.innerHTML = '<tr><td colspan="2" class="muted">No logs yet</td></tr>';
          return;
        }
        rows.forEach(r => {
          const tr = document.createElement('tr');
          const td1 = document.createElement('td');
          // Format date slightly more mobile-friendly
          td1.innerText = new Date(r.timestamp).toLocaleDateString() + ' ' + new Date(r.timestamp).toLocaleTimeString();
          const td2 = document.createElement('td');
          td2.innerText = r.result + (r.confidence ? (' (' + Math.round(r.confidence * 100) + '%)') : '');
          tr.appendChild(td1);
          tr.appendChild(td2);
          logsTableBody.appendChild(tr);
        });
      }

      function exportCSV() {
        window.open('/export', '_blank');
      }

      // --- Simple actions: verify / correct / share (reused) ---
      function markVerified() {
        showModal('Your name (for community record):', true, (name) => {
          if (!name) return;
          const data = new URLSearchParams();
          data.append('log_id', lastLogId || '0');
          data.append('user', name);
          data.append('correct_label', '');
          fetch('http://192.168.0.100/feedback', { method: 'POST', body: data })
            .then(() => { showModal('Thanks ‚Äî verified (saved).'); showLogs(); })
            .catch(() => { showModal('Saved locally (demo).'); });
        });
      }

      function correctLabel() {
        showModal('Correct label (healthy, drying, disease, pest, risk):', true, (lab) => {
          if (!lab) return;
          showModal('Your name:', true, (name) => {
            if(!name) return;
            const data = new URLSearchParams();
            data.append('log_id', lastLogId || '0');
            data.append('user', name);
            data.append('correct_label', lab);
            fetch('http://192.168.0.100/feedback', { method: 'POST', body: data })
              .then(() => { showModal('Correction saved.'); showLogs(); })
              .catch(() => { showModal('Saved locally (demo).'); });
          });
        });
      }

      function openShare() {
        showModal('Share to (group name or phone):', true, (to) => {
          if (!to) return;
          showModal('Message (optional):', true, (msg) => {
            if (msg === null) return; 
            const data = new URLSearchParams();
            data.append('log_id', lastLogId || '0');
            data.append('shared_by', 'volunteer');
            data.append('shared_to', to);
            data.append('message', msg);
            fetch('/share_report', { method: 'POST', body: data })
              .then(() => { showModal('Queued for manual sharing.'); })
              .catch(() => { showModal('Queued locally (demo).'); });
          });
        });
      }

      // --- Initial setup on load ---
      setLang('en');
      setTimeout(showLogs, 600); // Try to fetch logs on load

    });
  </script>
</body>
</html>